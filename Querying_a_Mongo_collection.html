<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Query a Mongo collection with Mongoose - My Zettelkasten</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="We now have the following entries in our courses collection:" name="description" /><meta content="Query a Mongo collection with Mongoose" property="og:title" /><meta content="My Zettelkasten" property="og:site_name" /><meta content="article" property="og:type" /><meta content="Querying_a_Mongo_collection" property="neuron:zettel-id" /><meta content="Querying_a_Mongo_collection" property="neuron:zettel-slug" /><meta content="databases" property="neuron:zettel-tag" /><meta content="mongo-db" property="neuron:zettel-tag" /><meta content="mongoose" property="neuron:zettel-tag" /><meta content="node-js" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(33,133,208,0.1)}body nav.bottomPane{background-color:rgba(33,133,208,2.0e-2)}body div#footnotes{border-top-color:#2185d0}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#2185d0;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(33,133,208,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><script
  async=""
  id="MathJax-script"
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
></script>
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"
  rel="stylesheet"
/><link rel="preconnect" href="https://fonts.googleapis.com" /><link
  rel="preconnect"
  href="https://fonts.gstatic.com"
  crossorigin
/><link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Serif:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
  rel="stylesheet"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
<style>
  body .ui.container,
  body ul {
    font-family: "IBM Plex Sans" !important;
  }
  body blockquote {
    border-left-width: 3px !important;
    font-style: italic;
  }
  .headerFont,
  .ui.header,
  body h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: "IBM Plex Sans Condensed" !important;
  }
  body p {
    line-height: 1.4;
  }
  .monoFont,
  body code,
  pre,
  tt {
    font-family: "IBM Plex Mono" !important;
    font-size: 12px !important;
    line-height: 1.4 !important;
  }
</style>
<!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Query a Mongo collection with Mongoose</h1><p>We now have the following entries in our <code>courses</code> collection:</p><pre><code class="js language-js">{
  name: &#39;Python Course&#39;,
  author: &#39;Terry Ogleton&#39;,
  tags: [ &#39;python&#39;, &#39;backend&#39; ],
  isPublished: true,
  _id: new ObjectId(&quot;62f4e2527ac4aa2c30d41d23&quot;),
  date: 2022-08-11T11:04:50.750Z,
  __v: 0
}

{
  name: &#39;Javascript Course&#39;,
  author: &#39;Tosh Gnomay&#39;,
  tags: [ &#39;js&#39;, &#39;frontend&#39; ],
  isPublished: true,
  _id: new ObjectId(&quot;62f4e2527ac4aa2c30d41d24&quot;),
  date: 2022-08-11T11:04:50.750Z,
  __v: 0
}
</code></pre><p>Now we will query the collection. This capability is provided via the Mongoose schema class we used to create the <code>Course</code> <a href="Create_collections_and_documents_with_Mongoose.md#models">model</a>. We have the following methods available to use from the schema:</p><ul><li><code>find</code></li><li><code>findById</code></li><li><code>findByIdAndRemove</code></li><li><code>findByIdAndUpdate</code></li><li><code>findOne</code></li><li><code>findOneAndUpdate</code></li><li><code>findOneAndRemove</code></li><li>…</li></ul><p>The various <code>find</code> methods return a value that is promisified.</p><h2 id="return-values-with-find">Return values with <code>find</code></h2><pre><code class="js language-js">async function getCourses() {
  const courses = await Course.find();
  console.log(courses);
}</code></pre><h2 id="filter-values-returned">Filter values returned</h2><p>This will return all the published courses where Tosh Gnomay is the author:</p><pre><code class="js language-js">async function getCourses() {
  const courses = await Course.find({
    author: &quot;Tosh Gnomay&quot;,
    isPublished: true,
  });
  console.log(courses);
}</code></pre><p>This time we will filter by the same author but we will add additional parameters to distinguish:</p><ul><li>only the first ten entries (using <code>.limit(10)</code>)</li><li>sort ascending by name (using <code>.sort({name: 1}))</code> , to descend we would use <code>-1</code>)</li><li>only return the properties <code>name</code> and <code>tags</code> for the item in the collection (using <code>.select({name: 1, tags: 1})</code>)</li></ul><pre><code class="js language-js">async function getCourses() {
  const courses = await Course.find({
    author: &quot;Tosh Gnomay&quot;,
    isPublished: true,
  })
    .limit(10)
    .sort({ name: 1 })
    .select({ name: 1, tags: 1 });
  console.log(courses);
}</code></pre><p>This returns:</p><pre><code class="js language-js">[
  {
    _id: new ObjectId(&quot;62f4f07a875cff48827b8731&quot;),
    name: &quot;Java Course&quot;,
    tags: [&quot;java&quot;, &quot;backend&quot;],
  },
  {
    _id: new ObjectId(&quot;62f4e2527ac4aa2c30d41d24&quot;),
    name: &quot;Javascript Course&quot;,
    tags: [&quot;js&quot;, &quot;frontend&quot;],
  },
];</code></pre><blockquote><p>Note that the UUID is always returned, whether we specify it or not.</p></blockquote><h2 id="querying-with-operators">Querying with operators</h2><p>So far when filtering we have been doing so with reference to properties that exist on the document’s model (<code>author</code>, <code>isPublished</code> etc) and we have applied tranformations on the data returned (sorting, limiting the number or matches etc.). However we can also apply <strong>operators</strong> within our queries. Operators allow us to perform computations on the data, for example: for a given numerical property on an object, return the objects for which this value is within a certain range.</p><p>When we apply operators we use the <code>$</code> symbol before the operator and pass the operator function as an object.</p><p>The schema:</p><pre><code class="language-none">Model.find( { property: { $operator: conditions } } )</code></pre><h3 id="comparison-operators">Comparison operators</h3><p>The following comparison operators are available in MongoDB:</p><table class="ui table"><thead><tr><th>Operator</th><th>Function</th></tr></thead><tbody><tr><td><code>eq</code></td><td>Equal to</td></tr><tr><td><code>ne</code></td><td>Not equal to</td></tr><tr><td><code>gt</code></td><td>Greater than</td></tr><tr><td><code>gte</code></td><td>Greater than or less than</td></tr><tr><td><code>lt</code></td><td>Less than</td></tr><tr><td><code>lte</code></td><td>Less than or equal to</td></tr><tr><td><code>in</code></td><td>In</td></tr><tr><td><code>nin</code></td><td>Not in</td></tr></tbody></table><p>We can employ these comparators within a <code>.find</code> filter. For example let’s imagine that our <code>courses</code> instances have a property of <code>price</code>.</p><p>To filter course prices that are greater than or equal to 10 and less than or equal to 29:</p><pre><code class="js language-js">Course.find({ price: { $gte: 10, $lte: 20 } });</code></pre><p>To filter course prices that are either 10, 15 or 20:</p><pre><code class="js language-js">Course.find({ price: { $in: [10, 15, 20] } });</code></pre><h3 id="logical-operators">Logical operators</h3><p>When we apply logical operators, we do not apply the query within the main <code>find</code> method. We use a dedicated method that corresponds to the logical predicate.</p><p>For example to query by logical <a href="Truth-functional_connectives.md#disjunction">OR</a>:</p><pre><code class="js language-js">async function getCourses() {
  const courses = await Course.find().or([
    { author: &quot;Tosh Gnomay&quot; },
    { isPublished: true },
  ]);
  console.log(courses);
}</code></pre><p>We write each disjunct as an object representing the conditions we are filtering for within an array that is passed to the <code>.or()</code> method.</p><p>The same syntax applies for conjunction.</p><h3 id="regular-expressions">Regular expressions</h3><p>When filtering by strings we can use Regex for greater power.</p><p>Previously we filtered by the author name:</p><pre><code class="js language-js">.find({author: &quot;Tosh Gnomay&quot;})</code></pre><p>To demonstrate regex we could filter by names beginning with <code>T</code>:</p><pre><code class="js language-js">.find({author: /^T*/})</code></pre><pre><code class="js language-js">async function getCourses() {
  const courses = await Course.find()
    .or([{ author: &quot;Tosh Gnomay&quot; }, { isPublished: true }])
    .count();
  console.log(courses);
}</code></pre><p>This will return a number.</p><h3 id="pagination">Pagination</h3><p>We previously used the <code>limit()</code> method to control how many matches we return from a query. We can extend this functionality by creating pagination. This allows us to meter the return values into set chunks. This is used frequently when interacting with a database through a mediating RESTful API. For example to return values from endpoints such as:</p><pre><code class="language-none">/api/courses?pageNumber=2&amp;pageSize=10</code></pre><p>To do this you pass two values as query parameters</p><pre><code class="js language-js">const pageNumber = 2;
const pageSize = 10;

async function getCourses() {
  const courses = await Course.find()
    .skip(pageNumber - 1 * pageSize)
    .limit(pageSize);
  console.log(courses);
}</code></pre></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header">Backlinks</h3><ul class="backlinks"><li><span class="zettel-link-container cf"><span class="zettel-link"><a href="Update_a_Mongo_document">Update a MongoDB document</a></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><p>With this approach we first execute a <span class="zettel-link-container cf"><span class="zettel-link" title="Zettel: Query a Mongo collection with Mongoose"><a href="Querying_a_Mongo_collection">query</a></span></span> to retrieve the document we want to edit and then make the change. We use the <code>findById</code> method to identify the document by its UUID and then <code>set</code> to update specified properties on the document. The <code>set</code> method is one of many operators that can be used to update values. For example there is also built-in operators for increment, renaming, multiplying values.</p></div></li></ul></li><li><span class="zettel-link-container cf"><span class="zettel-link"><a href="5__Integrating_the_Mongo_database">Creating a RESTful API: Integrating the database</a></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><p>Now we need to rewrite our RESTful request handlers so that the data is sourced from and added to the database. We will mainly be using the Mongo syntax defined at <span class="zettel-link-container cf"><span class="zettel-link" title="Zettel: Query a Mongo collection with Mongoose"><a href="Querying_a_Mongo_collection">Querying a collection</a></span></span> and <span class="zettel-link-container cf"><span class="zettel-link" title="Zettel: Adding documents to a collection"><a href="Adding_documents_to_a_Mongo_collection">Adding documents to a collection</a></span></span>. We will also keep API validation within the <code>/model/</code> file.</p></div></li></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">databases</span><span class="ui basic label zettel-tag" title="Tag">mongo-db</span><span class="ui basic label zettel-tag" title="Tag">mongoose</span><span class="ui basic label zettel-tag" title="Tag">node-js</span></div></nav><nav class="ui bottom attached icon compact inverted menu blue" id="neuron-nav-bar"><!--replace-start-9--><!--replace-end-9--><a class="right item" href="impulse" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.35.3" /></a></div></div></div></body></html>